# TODO: План разработки

Этот документ отслеживает следующие шаги в разработке проекта `days-afterX_bot`.

## Этап 1: Базовая логика бота и взаимодействие с пользователем

**Цель:** Научить бота регистрировать пользователей и обрабатывать базовые команды.

-   [ ] **1.1. Создание точки входа (`src/main.py`):**
    -   [ ] Настроить базовую конфигурацию логирования.
    -   [ ] Инициализировать `Bot` и `Dispatcher` из `aiogram`.
    -   [ ] Реализовать graceful shutdown (корректное завершение работы).
    -   [ ] Запустить `polling` бота.

-   [ ] **1.2. Регистрация/приветствие пользователя (хендлер на `/start`):**
    -   [ ] Создать `src/handlers/start.py`.
    -   [ ] При получении команды `/start`, проверять, есть ли пользователь в БД.
    -   [ ] Если пользователя нет — добавлять его в таблицу `users`.
    -   [ ] Отправлять приветственное сообщение с кратким описанием функций бота.

-   [ ] **1.3. Реализация CRUD для событий:**
    -   [ ] **Создание (`/new_event`):** Реализовать диалог (FSM) для добавления нового события (запрос названия, запрос даты).
    -   [ ] **Чтение (`/my_events`):** Реализовать команду для вывода списка всех событий пользователя с подсчетом дней.
    -   [ ] **Удаление (`/del_event`):** Реализовать команду для удаления события (с подтверждением).
    -   [ ] **Обновление (`/edit_event`):** (Опционально, можно отложить) Реализовать команду для редактирования события.

## Этап 2: Настройка фоновых задач (Scheduler)

**Цель:** Реализовать отправку ежедневных и периодических отчетов.

-   [ ] **2.1. Настройка APScheduler:**
    -   [ ] Интегрировать `APScheduler` с `aiogram`.
    -   [ ] Настроить отправку ежедневного отчета в указанное в `.env` время.

-   [ ] **2.2. Логика отчета:**
    -   [ ] Создать функцию, которая для каждого пользователя собирает его события и форматирует отчет.
    -   [ ] Отправлять отчет каждому пользователю персонально.

## Этап 3: Продакшен-окружение Docker

**Цель:** Подготовить безопасный, минимальный и воспроизводимый образ для продакшена.

-   [ ] **3.1. Отдельный `Dockerfile.prod` с multi-stage сборкой:**
    -   [ ] Stage `builder`: установка Poetry, установка зависимостей в виртуальное окружение.
    -   [ ] Stage `runtime`: `python:3.11-slim` + копирование только `.venv` и `src/` в конечный образ.
    -   [ ] Удалить `entrypoint.sh` в продакшене — зависимости уже внутри образа.
    -   [ ] Установить `PYTHONUNBUFFERED=1`, `PYTHONDONTWRITEBYTECODE=1`.

-   [ ] **3.2. Отдельный `docker-compose.prod.yml`:**
    -   [ ] Не монтировать исходники, только переменные окружения (через `.env` или секреты).
    -   [ ] Выставить политики рестартов `restart: always`.
    -   [ ] Настроить healthcheck для `bot` и `postgres`.

-   [ ] **3.3. Оптимизация размера образа:**
    -   [ ] Включить `--no-dev` зависимости, если будем делить на prod/dev в Poetry.
    -   [ ] Использовать `pip cache dir` и очистку после сборки, если будем использовать `pip` на финальном этапе.

-   [ ] **3.4. Безопасность:**
    -   [ ] Запускать приложение в контейнере от непривилегированного пользователя.
    -   [ ] Прятать секреты через Docker Secrets (или переменные окружения в CI/CD).
    -   [ ] Отключить лишние порты, оставить только необходимые.

-   [ ] **3.5. CI/CD:**
    -   [ ] GitHub Actions: сборка образа, прогон тестов, пуш в Registry (GHCR/Docker Hub).
    -   [ ] Автоматический деплой на staging/production.

## Этап 4: Улучшения и рефакторинг

**Цель:** Повысить качество и надежность кода.

-   [ ] **4.1. Создание репозиториев:**
    -   [ ] Вынести всю работу с базой данных из хендлеров в отдельный слой "репозиториев" (`src/db/repositories`).

-   [ ] **4.2. Покрытие тестами:**
    -   [ ] Настроить `pytest`.
    -   [ ] Написать базовые тесты для хендлеров и логики работы с БД.

-   [ ] **4.3. Документация:**
    -   [ ] Обновить `QUICK_START_guide.md` с описанием новых команд.
    -   [ ] Добавить комментарии и docstring'и в код.
